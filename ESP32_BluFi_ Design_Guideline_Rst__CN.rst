BLUFI
*****

概览
====
ESP32 的蓝牙配网功能称为 BLUFI。

BLUFI 基于 GATT，定义了 ESP32 作为 GATT Server 接收 GATT Client （手机等设备）的 Wi-Fi 连接信息，实现 ESP32 通过 Wi-Fi 连接 AP 或配置使用 SoftAP Profile 的过程。必要功能包含 BLUFI 层上的分片、数据加密、校验和确认等。

你可以自定义 BLUFI 配网过程中使用的对称加密、非对称加密以及校验算法。 BLUFI 提供的示例程序默认将使用 DH 算法进行密钥协商，使用 128-AES 算法进行数据加密，使用 CRC16 进行进行数据校验。

流程:
----
BLUFI 配网功能包含配置 SoftAP 和 Station 两部分。

下面以配置 Station 为例说明配置步骤。
BLUFI 配网的配置 Station 包含广播、连接、服务发现、协商共享密钥、传输数据、回传连接状态等步骤。

完整的配网过程如下：
----------------

1. ESP32 开启 GATT Server 功能，发送带有特定 ***adv data*** 的广播。你可以自定义该广播，该广播不属于 BLUFI Profile。

2. 使用手机 APP 搜索到该特定广播，手机作为 GATT Client 连接 ESP32。你可以决定使用哪款手机 APP。

3. GATT 连接建立成功后，手机向 ESP32 发送『协商过程』的数据包（见 BLUFI 传输格式）。

4. ESP32 收到『协商过程』的数据包后，会解析按照使用者自定义的协商过程来解析。

5. 手机与 ESP32 进行密钥协商。协商过程可使用 DH/RSA/ECC 等加密算法进行。

6. 协商结束后，手机端向 ESP32 发送『设置安全模式』控制包。

7. ESP32 收到『设置安全模式』控制包后，将使用经过协商的共享密钥以及配置的安全策略对通信数据进行加密和解密。

8. 手机向 ESP32 发送『BLUFI 传输格式』定义的 SSID、PASSWORD 等用于 Wi-Fi 连接的必要信息。

9. 手机向 ESP32 发送『Wi-Fi 连接请求』控制包，ESP32 收到之后，识别为手机已将必要的信息传输完毕，准备连接 Wi-Fi。

10. ESP32 连接到 Wi-Fi 后，发送『Wi-Fi 连接状态报告』控制包到手机，以报告连接状态。至此配网结束。

.. note::

    1. 安全模式设置可在任何时候进行，ESP32 收到安全模式的配置后，会根据安全模式指定的模式进行安全相关的操作。

    2. 进行对称加密和解密时，加密和解密前后的数据长度必须一致，支持原地加密和解密。

配网流程图请参考下图：

.. figure:: https://github.com/Freddy-Jin/ESP32_BLUFI_-Design_Guidelines/blob/master/Docs/Figure1.png
    :align: center
    :figclass: align-center

BLUFI 传输格式
*************

手机 APP 与 ESP32 之间的 BLUFI 通信格式定义如下：

帧不分段情况下的标准格式（8 位字节）：

+------------+---------------+-----------------+-------------+----------------+----------------+
| Type (LSB) | Frame Control | Sequence Number | Data Length |      Data      | CheckSum (MSB) |
+------------+---------------+-----------------+-------------+----------------+----------------+
|      1     |       1       |        1        |      1      | ${Data Length} |        2       |
+------------+---------------+-----------------+-------------+----------------+----------------+

如果 **Frame Control** 帧中的 **More Frag** 位值为 1，则**Total Content Length** 为数据帧中剩余部分的总长度，用于告知终端需要分配多少内存。帧分段格式（8 位字节）：

+------------+---------------+-----------------+-------------+-------------------------------------------+----------------+
| Type (LSB) | Frame Control | Sequence Number | Data Length |                    Data                   | CheckSum (MSB) |
+------------+---------------+-----------------+-------------+-------------------------------------------+----------------+
|      1     |       1       |        1        |      1      | Total Content Length |       Content      |        2       |
+            +               +                 +             +----------------------+--------------------+                +
|            |               |                 |             |           2          | ${Data Length} - 2 |                |
+------------+---------------+-----------------+-------------+----------------------+--------------------+----------------+

通常情况下，控制帧不包含数据位，Ack 帧类型除外。Ack 帧格式（8 位字节）：

+------------+---------------+-----------------+-------------+-----------------------+----------------+
| Type (LSB) | Frame Control | Sequence Number | Data Length |          Data         | CheckSum (MSB) |
+------------+---------------+-----------------+-------------+-----------------------+----------------+
|      1     |       1       |        1        |      1      | Acked Sequence Number |        2       |
+            +               +                 +             +-----------------------+                +
|            |               |                 |             |           1           |                |
+------------+---------------+-----------------+-------------+-----------------------+----------------+

1. Type

   类型域，占 1 Byte。分为 Type 和 Subtype（子类型域）两部分, Type 占低 2 bit，Subtype 占高 6 bit。
   * 控制帧，暂不进行加密，可校验；
   * 数据帧，可加密，可校验。
+---------+--------+--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Type    | 含义   | Subtype      | 含义                                                   | 解释                                                                                                                                                                                      | 备注                                                                                                                                                                                                                                                                  |
+---------+--------+--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x0b’00 | 控制帧 | 0x0b’000000  | Ack                                                    | 用来回复对方发的帧，Ack 帧的数据域为要回复的帧的 Sequence 值。                                                                                                                            | Data 域为1 Byte 的 Sequence 值，与要回复的帧的Sequence 相同。                                                                                                                                                                                                         |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x1b’000001  | Set ESP32 to Phone Security mode                       | 通知 ESP32，ESP32 发送数据时使用的安全模式，过程中可多次设置。每次设置后影响后续安全模式。不设置的情况下，ESP32 默认控制帧和数据帧均为无校验、无加密。手机到 ESP32 方向依赖于帧控制域。   | Data 域 1 字节。高 4 bit 为控制帧的安全模式，低 4bit 为数据帧的安全模式。b’0000 为无校验、无加密；b’0001 为有校验、无加密；b’0010 为无校验、有加密；b’0011 为有校验有加密。                                                                                           |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x2b’000010  | Set Wi-Fi Opmode                                       | 设置 ESP32 的 Wi-Fi 模式，帧包含 opmode。                                                                                                                                                 | data[0] 表示 opmode：0x00: NULL；0x01: STA;0x02: SoftAP;0x03: SoftAP&STA如果设置有包含 AP，请尽量优先设置 AP 模式的SSID/PASSWORD/Max Conn Number等。                                                                                                                  |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x3b’000011  | Connect to AP                                          | 通知 ESP32，必要的信息已经发送完毕，可以连接 AP。                                                                                                                                         | 无数据域。                                                                                                                                                                                                                                                            |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x4b’000100  | Disconnect From AP                                     | 通知 ESP32 断开与 AP 的连接                                                                                                                                                               | 无数据域。                                                                                                                                                                                                                                                            |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x5b’000101  | Get Wifi Status                                        | 获取 ESP32 的 Wi-Fi 模式和状态等信息。                                                                                                                                                    | 无数据域。ESP32 收到此控制帧后，后续会通过 Wi-Fi Connection State Report 数据帧来回复手机端当前所处的 opmode、连接状态、SSID 等信息。这些信息由应用决定提供给手机端多少信息。                                                                                         |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x6b’000110  | Deauthenticate STA Device from SOFTAP( in SoftAP mode) | 踢掉某个 STA 设备。（SOFTAP mode）                                                                                                                                                        | data[0~5] 为 STA 的 MAC 地址，如多个 STA，则 [6-11] 为第二个，依次类推。                                                                                                                                                                                              |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x7b'000111  | Get Version                                            |                                                                                                                                                                                           |                                                                                                                                                                                                                                                                       |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x8b’001000  | ESP32 Close BLE GATT Connection                        | 通知 ESP32 断开蓝牙连接                                                                                                                                                                   | ESP32 收到该指令后主动断开蓝牙连接。                                                                                                                                                                                                                                  |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x9b’001001  | ESP32 Get Wi-fi List                                   | 通知 ESP32 扫描周围的 Wi-Fi 热点                                                                                                                                                          | 无数据域ESP32收到此控制帧后，后续会通过Wifi List Report数据帧来回复手机端当前ESP32 周围的Wifi 热点。                                                                                                                                                                  |
+---------+--------+--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x1b’01 | 数据帧 | 0x0b’000000  | Negotiate Data                                         | 用来发送协商数据，将会传给应用层注册的回调函数                                                                                                                                            | 数据长度与 Length 域有关。                                                                                                                                                                                                                                            |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x1b’000001  | BSSID for STA mode                                     | STA将要连接的AP的BSSID（为隐藏SSID用）。                                                                                                                                                  | 数据长度与 Length 域有关。当传输方向为 ESP32 到手机时，表示向手机端提供信息。                                                                                                                                                                                         |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x2b’000010  | SSID for STA mode                                      | STA 将要连接的 AP 的 SSID                                                                                                                                                                 | 数据长度与 Length 域有关。当传输方向为 ESP32 到手机时，表示向手机端提供信息。                                                                                                                                                                                         |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x3b’000011  | Password for STA mode                                  | STA 将要连接的 AP 的密码                                                                                                                                                                  | 数据长度与 Length 域有关。当传输方向为 ESP32 到手机时，表示向手机端提供信息。                                                                                                                                                                                         |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x4b’000100  | SSID for SoftAP mode                                   | SoftAP 模式使用的 SSID                                                                                                                                                                    | 数据长度与 Length 域有关。当传输方向为ESP32 到手机时，表示向手机端提供信息。                                                                                                                                                                                          |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x5b’000101  | Password for SoftAPmode                                | SoftAP 模式使用的密码                                                                                                                                                                     | 数据长度与 Length 域有关。当传输方向为 ESP32 到手机时，表示向手机端提供信息。                                                                                                                                                                                         |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x6b’000110  | Max Connection Number for SoftAP mode                  | AP 模式的最大连接数                                                                                                                                                                       | data[0] 表示连接数的值。范围 1~4。当传输方向为 ESP32 到手机时，表示向手机端提供信息。                                                                                                                                                                                 |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x7b’000111  | Authentication mode for SoftAP mode                    | AP 模式的认证模式                                                                                                                                                                         | data[0]：0x00: OPEN0x01: WEP0x02: WPA_PSK0x03: WPA2_PSK0x04:WPA_WPA2_PSK。当传输方向为 ESP32 到手机时，表示向手机端提供信息。                                                                                                                                         |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x8b’001000  | Channel For SoftAP mode                                | SoftAP 模式的 Channel                                                                                                                                                                     | data[0] 为 Channel 值。范围 1~14。当传输方向为 ESP32 到手机时，表示向手机端提供信息。                                                                                                                                                                                 |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x9b’001001  | Username                                               | 使用企业级加密时，Client 端的 username                                                                                                                                                    | 数据长度与 Length 域有关                                                                                                                                                                                                                                              |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0xab’001010  | CA Certification                                       | 企业级加密时，CA 证书                                                                                                                                                                     | 数据长度与 Length 域有关，长度不够，可用分片。                                                                                                                                                                                                                        |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0xbb’001011  | Client Certification                                   | 企业级加密时，Client端的证书（可包含或不包含Private Key，由证书内容决定）                                                                                                                 | 数据长度与 Length 域有关，长度不够，可用分片。                                                                                                                                                                                                                        |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0xcb’001100  | Server Certification                                   | 企业级加密时，Server 端的证书（可包含或不包含 Private Key，由证书内容决定）                                                                                                               | 数据长度与 Length 域有关，长度不够，可用分片。                                                                                                                                                                                                                        |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0xdb’001101  | ClientPrivate Key                                      | 企业级加密时，Client 端的私钥。                                                                                                                                                           | 数据长度与 Length 域有关，长度不够，可用分片。                                                                                                                                                                                                                        |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0xeb’001110  | ServerPrivate Key                                      | 企业级加密时，Server 端的私钥。                                                                                                                                                           | 数据长度与 Length 域有关，长度不够，可用分片。                                                                                                                                                                                                                        |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0xfb’001111  | Wi-Fi Connection State Report                          | 通知手机 ESP32 的 Wi-Fi 状态，包括 STA状态和 SoftAP 状态。用于手机配置 STA 连接时的通知，或有 STA 连接上 SoftAP 时的通知。但收到手机询问 Wi-Fi 状态，除了回复此帧外，还可回复其他数据帧。 | data[0]:表示 opmode，0x00: NULL；0x01: STA;0x02: SoftAP;0x03: SoftAP&STAdata[1]：表示 STA 的连接状态，0x0 表示处于连接状态， 其他表示处于非连接状态；data[2]：表示 SoftAP 的连接状态，即表示有多少 STA 已经连接。data[3] 及以后，为按照本协议格式 SSID\BSSID 等信息。 |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x10b’010000 | Version                                                |                                                                                                                                                                                           | data[0]= great versiondata[1]=sub version                                                                                                                                                                                                                             |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x11B’010001 | Wifi List                                              | 通知手机，包含 ESP32 周围的 Wi-Fi 热点列表。                                                                                                                                              | 数据帧数据格式为 ( Length + RSSI + SSID ), 数据较长时分片发送                                                                                                                                                                                                         |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x12B’010010 | Report Error                                           | 通知手机, BLUFI 出现异常错误。                                                                                                                                                            | 0x00: sequence error0x01: checksum error0x02: decrypt error0x03: encrypt error0x04: init security error0x05: dh malloc error0x06: dh param error0x07: read param  error0x08: make public error                                                                        |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x13B’010011 | Custom Data                                            | 用户发送或者接收自定义数据。                                                                                                                                                              | 数据较长时分片发送。                                                                                                                                                                                                                                                  |
+---------+--------+--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

2. Frame Control

   帧控制域，占 1 Byte，每个 bit 表示不同含义。
   
   +----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Bit            | 含义                                                                                                                                                                                                                            |
+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x01           | 表示帧是否加密。1 表示加密，0 表示未加密。加密部分帧括完整的 DATA 域加密之前的明文（不帧含末尾的校验）。控制帧暂不加密，故控制帧此位为 0。                                                                                      |
+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x02           | 表示帧 Data 域结尾是否帧含校验（例如 SHA1,MD5,CRC等）需要校验的数据域包括 sequcne + data length + 明文 data。控制帧和数据帧都可以包含校验位或不包含。                                                                           |
+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x04           | 表示数据方向。0 表示手机发向 ESP32；1 表示 ESP32 发向手机。                                                                                                                                                                     |
+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x08           | 表示是否要求对方回复 ack。0 表示不要求；1 表示要求回复 ack。                                                                                                                                                                    |
+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x10           | 表示是否有后续的数据分片。0 表示此帧没有后续数据分片；1 表示还有后续数据分片。用来传输较长的数据。如果是 Frag 帧，则告知当前 content 部分+后续 content 部分的总长度，位于 Data 域的前 2 字节(即最大支持 64K 的 content 数据）。 |
+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x10~0x80 保留 |                                                                                                                                                                                                                                 |
+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

3. Sequence Control
   序列控制域，
