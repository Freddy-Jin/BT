BLUFI
*****

概览
====
ESP32 的蓝牙配网功能称为 BLUFI。

BLUFI 基于 GATT，定义了 ESP32 作为 GATT Server 接收 GATT Client （手机等设备）的 Wi-Fi 连接信息，实现 ESP32 通过 Wi-Fi 连接 AP 或配置使用 SoftAP Profile 的过程。必要功能包含 BLUFI 层上的分片、数据加密、校验和确认等。

你可以自定义 BLUFI 配网过程中使用的对称加密、非对称加密以及校验算法。 BLUFI 提供的示例程序默认将使用 DH 算法进行密钥协商，使用 128-AES 算法进行数据加密，使用 CRC16 进行进行数据校验。

流程:
----
BLUFI 配网功能包含配置 SoftAP 和 Station 两部分。

下面以配置 Station 为例说明配置步骤。
BLUFI 配网的配置 Station 包含广播、连接、服务发现、协商共享密钥、传输数据、回传连接状态等步骤。

完整的配网过程如下：
----------------

1. ESP32 开启 GATT Server 功能，发送带有特定 ***adv data*** 的广播。你可以自定义该广播，该广播不属于 BLUFI Profile。

2. 使用手机 APP 搜索到该特定广播，手机作为 GATT Client 连接 ESP32。你可以决定使用哪款手机 APP。

3. GATT 连接建立成功后，手机向 ESP32 发送『协商过程』的数据包（见 BLUFI 传输格式）。

4. ESP32 收到『协商过程』的数据包后，会解析按照使用者自定义的协商过程来解析。

5. 手机与 ESP32 进行密钥协商。协商过程可使用 DH/RSA/ECC 等加密算法进行。

6. 协商结束后，手机端向 ESP32 发送『设置安全模式』控制包。

7. ESP32 收到『设置安全模式』控制包后，将使用经过协商的共享密钥以及配置的安全策略对通信数据进行加密和解密。

8. 手机向 ESP32 发送『BLUFI 传输格式』定义的 SSID、PASSWORD 等用于 Wi-Fi 连接的必要信息。

9. 手机向 ESP32 发送『Wi-Fi 连接请求』控制包，ESP32 收到之后，识别为手机已将必要的信息传输完毕，准备连接 Wi-Fi。

10. ESP32 连接到 Wi-Fi 后，发送『Wi-Fi 连接状态报告』控制包到手机，以报告连接状态。至此配网结束。

.. note::

    1. 安全模式设置可在任何时候进行，ESP32 收到安全模式的配置后，会根据安全模式指定的模式进行安全相关的操作。

    2. 进行对称加密和解密时，加密和解密前后的数据长度必须一致，支持原地加密和解密。

配网流程图请参考下图：

.. figure:: https://github.com/Freddy-Jin/ESP32_BLUFI_-Design_Guidelines/blob/master/Docs/Figure1.png
    :align: center
    :figclass: align-center

BLUFI 传输格式
*************

手机 APP 与 ESP32 之间的 BLUFI 通信格式定义如下：

帧不分段情况下的标准格式（8 位字节）：

+------------+---------------+-----------------+-------------+----------------+----------------+
| Type (LSB) | Frame Control | Sequence Number | Data Length |      Data      | CheckSum (MSB) |
+------------+---------------+-----------------+-------------+----------------+----------------+
|      1     |       1       |        1        |      1      | ${Data Length} |        2       |
+------------+---------------+-----------------+-------------+----------------+----------------+

如果 **Frame Control** 帧中的 **More Frag** 位值为 1，则**Total Content Length** 为数据帧中剩余部分的总长度，用于告知终端需要分配多少内存。帧分段格式（8 位字节）：

+------------+---------------+-----------------+-------------+-------------------------------------------+----------------+
| Type (LSB) | Frame Control | Sequence Number | Data Length |                    Data                   | CheckSum (MSB) |
+------------+---------------+-----------------+-------------+-------------------------------------------+----------------+
|      1     |       1       |        1        |      1      | Total Content Length |       Content      |        2       |
+            +               +                 +             +----------------------+--------------------+                +
|            |               |                 |             |           2          | ${Data Length} - 2 |                |
+------------+---------------+-----------------+-------------+----------------------+--------------------+----------------+

通常情况下，控制帧不包含数据位，Ack 帧类型除外。Ack 帧格式（8 位字节）：

+------------+---------------+-----------------+-------------+-----------------------+----------------+
| Type (LSB) | Frame Control | Sequence Number | Data Length |          Data         | CheckSum (MSB) |
+------------+---------------+-----------------+-------------+-----------------------+----------------+
|      1     |       1       |        1        |      1      | Acked Sequence Number |        2       |
+            +               +                 +             +-----------------------+                +
|            |               |                 |             |           1           |                |
+------------+---------------+-----------------+-------------+-----------------------+----------------+

1. Type

   类型域，占 1 Byte。分为 Type 和 Subtype（子类型域）两部分, Type 占低 2 bit，Subtype 占高 6 bit。
   * 控制域，暂不进行加密，可校验；
   * 数据域，可加密，可校验。

2. Frame Control

   帧控制域，占 1 Byte，每个 bit 表示不同含义。

3. Sequence Control
   序列控制域，
