BLUFI
*****

BLUFI
*****

Overview
========
BluFi for ESP32 is a network-configuration funcion via Bluetooth channel.

It is built on the GATT protocol, which defines the procedure of ESP32 working as the GATT Server to connect the GATT Client (e.g. an SoftAP created by a mobile phone) through Wi-Fi or configuring for the SoftAP Profile. Sharding, data encryption, checksum verification in the BluFi layer are the key parts that need your attention.

The algorithms of symmetric encryption, asymmetric encryption and checksum support custmization on your demand in practical use. Here we use the DH algorithm for key negotiation, 128-AES algorithm for data encryption, and CRC16 algorithm for checksum verification.

The BluFi Flow:
---------------
The BluFi networking flow includes the configuration of the SoftAP and Station.

Take the configuration of the Station as an example to illustrate the core parts of the procedure, including broadcast, connection, service discovery, negotiation of the shared key, data transmission, connection status backhaul.

The procedure is as follows:
------------------------------

1. Set the ESP32 into GATT Server mode and then it will send broadcasts with specific *adv data*. You can customize this broadcast as needed, which is not a part of the BluFi Profile.

2. Use the APP installed on the mobile phone to search for this particular broadcast. The mobile phone will connect to ESP32 as the GATT Client once the broadcast is confirmed. The APP used during this part is up to you.

3. After the GATT connection is successfully established, the mobile phone will send a data frame for key negotiation to ESP32 (see the section of "The Formats of Data Frames" for details).

4. After ESP32 receives the data frame of key negotiation, it will parse the content according to the user-defined negotiation method.

5. The mobile phone works with ESP32 for key negotiation using the encryption algorithms such as DH, RSA or ECC

6. After the negotiation process is completed, the mobile phone will send a control frame for security-mode setup to ESP32.

7. When receiving this control frame, ESP32 will be able to encrypt and decrypt the communication data using the shared key and the security configuration.

8. The mobile phone sends the data frame defined in the section of "The Formats of Data Frames"，with the Wi-Fi configuration information to ESP32, including SSID, password, etc.

9. The mobile phone sends a control frame of Wi-Fi connection request to ESP32. When receiving this control frame, ESP32 will regard the communication of essential information as done and get ready to connect to the Wi-Fi.

10. After connecting to the Wi-Fi, ESP32 will send a control frame of Wi-Fi connection status report to the mobile phone，to report the connection status. At this point the networking procedure is completed.

.. note::

    1. After ESP32 receives the control frame of security-mode configuration, it will execute the operations in accordance with the defined security mode.

    2. The data lengths before and after symmetric encryption/decryption must stay the same. It also supports in-place encryption and decryption.

The Flow Chat of BluFi:

.. figure:: https://github.com/Freddy-Jin/ESP32_BLUFI_-Design_Guidelines/blob/master/Docs/Figure1.png
    :align: center
    :figclass: align-center

The Frame Formats Defined in BluFi
***************************************

The frame formats for the communication between the mobile phone APP and ESP32 is defined as follows:

The frame format with no fragment (8 bit)：

+------------+---------------+-----------------+-------------+----------------+----------------+
| Type       | Frame Control | Sequence Number | Data Length |      Data      | CheckSum       |
+------------+---------------+-----------------+-------------+----------------+----------------+
|      1     |       1       |        1        |      1      | ${Data Length} |        2       |
+------------+---------------+-----------------+-------------+----------------+----------------+

If the **Frame Ctrl** bit is enabled, the **Total length** bit indicates the length of data frame's rest part. It can tell the remote how much memory needs to be alloced.


The frame format with fragments（8 bit）：

+------------+---------------+-----------------+-------------+-------------------------------------------+----------------+
| Type       | Frame Control | Sequence Number | Data Length |                    Data                   | CheckSum       |
+------------+---------------+-----------------+-------------+-------------------------------------------+----------------+
|      1     |       1       |        1        |      1      | Total Content Length |       Content      |        2       |
+            +               +                 +             +----------------------+--------------------+                +
|            |               |                 |             |           2          | ${Data Length} - 2 |                |
+------------+---------------+-----------------+-------------+----------------------+--------------------+----------------+

Normally, the control frame does not contain data bits, except for Ack frame.

The format of Ack Frame（8 bit）：

+------------+---------------+-----------------+-------------+-----------------------+----------------+
| Type       | Frame Control | Sequence Number | Data Length |          Data         | CheckSum       |
+------------+---------------+-----------------+-------------+-----------------------+----------------+
|      1     |       1       |        1        |      1      | Acked Sequence Number |        2       |
+            +               +                 +             +-----------------------+                +
|            |               |                 |             |           1           |                |
+------------+---------------+-----------------+-------------+-----------------------+----------------+

1. Type

   Type field, taking 1 Byte, is divided into Type and Subtype that Type uses the lower 2 bit and Subtype uses the upper 6 bit.

   * The control frame is not encrypted for the time being and supports to be verified;

   * The data frame supports to be encrypted and verified.
+---------+---------------+--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Type    | Frame Name    | Subtype      | Implication                                                  | Explanation                                                                                                                                                                                                                                                                                                                                                                                  | Note                                                                                                                                                                                                                                                                                                                                                                                                                                          |
+---------+---------------+--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x0b’00 | Control Frame | 0x0b’000000  | Ack                                                          | The data field of the Ack frame uses the same sequence value of the frame to reply to.                                                                                                                                                                                                                                                                                                       | The data field consumes a byte and its value is the same as the sequence field of the frame to reply to.                                                                                                                                                                                                                                                                                                                                      |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x1b’000001  | Set ESP32 to the security mode.                              | To inform ESP32 of the security mode to use when sending data, which is allowed to be reset multiple times during the process.Each setting affects the subsequent security mode used.If it is not set, ESP32 will send the control frame and data frame with no checksum and encryption by default.The data transmission from the mobile phone to ESP32 is controlled by this control frame. | The data field consumes a byte.The higher 4 bits are for the security mode setting of the control frame, and the lower 4 bits are for the security mode setting of the data frame.b’0000: no checksum and no encryption;b’0001: with checksum but no encryption;b’0010: no checksum but with encryption;b’0011: with both checksum and encryption.                                                                                            |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x2b’000010  | Set the opmode of Wi-Fi.                                     | The frame contains opmode settings for configuring for the Wi-Fi mode of ESP32.                                                                                                                                                                                                                                                                                                              | data[0] is for opmode settings, including:0x00: NULL；0x01: STA;0x02: SoftAP;0x03: SoftAP&STA.Please set the SSID/Password/Max Connection Number of the AP mode in the first place if an AP gets involved .                                                                                                                                                                                                                                   |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x3b’000011  | Connect ESP32 to the AP.                                     | To notify ESP32 that the  essential information has been sent and it is allowed to connect to the AP.                                                                                                                                                                                                                                                                                        | No data field is contained.                                                                                                                                                                                                                                                                                                                                                                                                                   |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x4b’000100  | Disconnect ESP32 from the AP.                                |                                                                                                                                                                                                                                                                                                                                                                                              | No data field is contained.                                                                                                                                                                                                                                                                                                                                                                                                                   |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x5b’000101  | To get the information of ESP32’s Wi-Fi mode and its status. |                                                                                                                                                                                                                                                                                                                                                                                              | No data field is contained.When receiving this control frame, ESP32 will send back a follow-up  frame of Wi-Fi connection state report to the mobile phone with the information of the current opmode, connection status, SSID and so on. The types of  information sent to the mobile phone is defined by the application installed on the phone.                                                                                            |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x6b’000110  | Disconnect the STA device from the SoftAP (in SoftAP mode).  |                                                                                                                                                                                                                                                                                                                                                                                              | Date[0~5] is taken as the MAC address for the STA device. If there is a second STA device, then it uses data[6-11] and the rest can be done in the same manner.                                                                                                                                                                                                                                                                               |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x7b'000111  | Get the version information.                                 |                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                               |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x8b’001000  | Disconnect the BLE GATT link.                                |                                                                                                                                                                                                                                                                                                                                                                                              | ESP32 will disconnect the BLE GATT link after receives this command.                                                                                                                                                                                                                                                                                                                                                                          |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x9b’001001  | Get the Wi-Fi list.                                          | To get ESP32 to scan the Wi-Fi access points around.                                                                                                                                                                                                                                                                                                                                         | No data field is contained.When receiving this control frame, ESP32 will send back a follow-up  frame of Wi-Fi list report to the mobile phone.                                                                                                                                                                                                                                                                                               |
+---------+---------------+--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x1b’01 | Data Frame    | 0x0b’000000  | Send the negotiation data.                                   | The negotiation data will be sent to the callback function registered in the application layer.                                                                                                                                                                                                                                                                                              | The length of the data depends on the length field.                                                                                                                                                                                                                                                                                                                                                                                           |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x1b’000001  | Send the BSSID for STA mode.                                 | To send the BSSID of the AP for the STA device to connect under the condition that  the SSID is hidden.                                                                                                                                                                                                                                                                                      | The length of the data depends on the length field.When the transmission direction is ESP32 to the mobile phone, it means to provide the mobile phone with the needed information.                                                                                                                                                                                                                                                            |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x2b’000010  | Send the SSID for STA mode.                                  | To send the SSID of the AP for the STA device to connect.                                                                                                                                                                                                                                                                                                                                    | The length of the data depends on the length field.When the transmission direction is ESP32 to the mobile phone, it means to provide the mobile phone with the needed information.                                                                                                                                                                                                                                                            |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x3b’000011  | Send the password for STA mode.                              | To send the password of the AP for the STA device to connect.                                                                                                                                                                                                                                                                                                                                | The length of the data depends on the length field.When the transmission direction is ESP32 to the mobile phone, it means to provide the mobile phone with the needed information.                                                                                                                                                                                                                                                            |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x4b’000100  | Send the SSID for SoftAP mode.                               |                                                                                                                                                                                                                                                                                                                                                                                              | The length of the data depends on the length field.When the transmission direction is ESP32 to the mobile phone, it means to provide the mobile phone with the needed information.                                                                                                                                                                                                                                                            |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x5b’000101  | Send the password for SoftAPmode.                            |                                                                                                                                                                                                                                                                                                                                                                                              | The length of the data depends on the length field.When the transmission direction is ESP32 to the mobile phone, it means to provide the mobile phone with the needed information.                                                                                                                                                                                                                                                            |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x6b’000110  | Set the maximum connection number for SoftAP mode.           |                                                                                                                                                                                                                                                                                                                                                                                              | data[0] represents the value of the connection number, ranging from 1 to 4.When the transmission direction is ESP32 to the mobile phone, it means to provide the mobile phone with the needed information.                                                                                                                                                                                                                                    |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x7b’000111  | Set the authentication mode for the SoftAP.                  |                                                                                                                                                                                                                                                                                                                                                                                              | data[0]：0x00: OPEN0x01: WEP0x02: WPA_PSK0x03: WPA2_PSK0x04:WPA_WPA2_PSK。When the transmission direction is ESP32 to the mobile phone, it means to provide the mobile phone with the needed information.                                                                                                                                                                                                                                     |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x8b’001000  | Set the channel amount for SoftAP mode.                      |                                                                                                                                                                                                                                                                                                                                                                                              | data[0] represents the quantity of the supported channels, ranging from 1 to 14.When the transmission direction is ESP32 to the mobile phone, it means to provide the mobile phone with the needed information.                                                                                                                                                                                                                               |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x9b’001001  | Username                                                     | It provides the username of the GATT client when using  encryption of enterprise level.                                                                                                                                                                                                                                                                                                      | The length of the data depends on the length field.                                                                                                                                                                                                                                                                                                                                                                                           |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0xab’001010  | CA Certification                                             | It provides the CA Certification when using encryption of enterprise level.                                                                                                                                                                                                                                                                                                                  | The length of the data depends on the length field. The frame supports to be fragmented if the data length is not enough.                                                                                                                                                                                                                                                                                                                     |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0xbb’001011  | Client Certification                                         | It provides the client certification when using encryption of enterprise level. Whether the private key is contained or not depends on the content of the certification.                                                                                                                                                                                                                     | The length of the data depends on the length field. The frame supports to be fragmented if the data length is not enough.                                                                                                                                                                                                                                                                                                                     |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0xcb’001100  | Server Certification                                         | It provides the sever certification when using encryption of enterprise level. Whether the private key is contained or not depends on the content of the certification.                                                                                                                                                                                                                      | The length of the data depends on the length field. The frame supports to be fragmented if the data length is not enough.                                                                                                                                                                                                                                                                                                                     |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0xdb’001101  | ClientPrivate Key                                            | It provides the private key of the client when using encryption of enterprise level.                                                                                                                                                                                                                                                                                                         | The length of the data depends on the length field. The frame supports to be fragmented if the data length is not enough.                                                                                                                                                                                                                                                                                                                     |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0xeb’001110  | ServerPrivate Key                                            | It provides the private key of the sever when using encryption of enterprise level.                                                                                                                                                                                                                                                                                                          | The length of the data depends on the length field. The frame supports to be fragmented if the data length is not enough.                                                                                                                                                                                                                                                                                                                     |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0xfb’001111  | Wi-Fi Connection State Report                                | To notify the phone of the ESP32's Wi-Fi status, including STA status and SoftAP status. It is used to for the STA connecting to the phone or the SoftAP.However, when the mobile phone receives the Wi-Fi status, it can reply to other frames in addition to replying to this frame.                                                                                                       | data[0]:Represents opmode，0x00: NULL；0x01: STA;0x02: SoftAP;0x03: SoftAP&STAdata[1]：Represents the connection state of the STA device, 0x0 indicates a connection state, and other representations are in a disconnected state;data[2]：Represents the connection state of the SoftAP , that is, how many STA have been connected.data[3] and the subsequent is in accordance with the format of SSID/BSSID information of this agreement. |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x10b’010000 | Version                                                      |                                                                                                                                                                                                                                                                                                                                                                                              | data[0]= great versiondata[1]=sub version                                                                                                                                                                                                                                                                                                                                                                                                     |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x11B’010001 | Wi-Fi List                                                   | To send the Wi-Fi list to ESP32.                                                                                                                                                                                                                                                                                                                                                             | The format of the data frame is length + RSSI + SSID and it supports to be sent into fragments if the data length is too long.                                                                                                                                                                                                                                                                                                                |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x12B’010010 | Report Error                                                 | To notify the mobile phone that there is an error with BluFi.                                                                                                                                                                                                                                                                                                                                | 0x00: sequence error0x01: checksum error0x02: decrypt error0x03: encrypt error0x04: init security error0x05: dh malloc error0x06: dh param error0x07: read param  error0x08: make public error                                                                                                                                                                                                                                                |
+         +               +--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |               | 0x13B’010011 | Custom Data                                                  | To send or receive custom data.                                                                                                                                                                                                                                                                                                                                                              | The data frame supports to be sent into fragments if the data length is too long.                                                                                                                                                                                                                                                                                                                                                             |
+---------+---------------+--------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

2. Frame Control

   帧控制域，占 1 Byte，每个 bit 表示不同含义。
   
+----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| bit            | 含义                                                                                                                                                                                                                  |
+----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x01           | 表示帧是否加密。1 表示加密，0 表示未加密。加密部分帧括完整的 Data 域加密之前的明文（不帧含末尾的校验）。控制帧暂不加密，故控制帧此位为 0。                                                                            |
+----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x02           | 表示帧 Data 域结尾是否帧含校验（例如 SHA1、MD5、CRC等）需要校验的数据域包括『序列 + 数据长度 + 明文数据』。控制帧和数据帧都可以包含校验位或不包含。                                                                   |
+----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x04           | 表示数据方向。0 表示手机发向 ESP32；1 表示 ESP32 发向手机。                                                                                                                                                           |
+----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x08           | 表示是否要求对方回复 Ack。0 表示不要求；1 表示要求回复 Ack。                                                                                                                                                          |
+----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x10           | 表示是否有后续的数据分片。0 表示此帧没有后续数据分片；1 表示还有后续数据分片。用来传输较长的数据。如果是 Frag 帧，则告知当前『内容部分+后续内容部分』的总长度，位于 Data 域的前 2 Byte (即最大支持 64K 的内容数据）。 |
+----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x10~0x80 保留 |                                                                                                                                                                                                                       |
+----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

3. Sequence Control

   序列控制域。帧发送时，无论帧的类型是什么，序列 (Sequence) 都会自动加 1，用来防止重放攻击 (Replay Attack)。每次重现连接后，序列清零。
   
4. Length

   Data 域的长度，不包含 CheckSum。
   
5. Data

   不同的 Type 或 Subtype，Data 域的含义均不同。请参考上方表格。

6. CheckSum

   此域为 2 Byte 的校验，用来校验『序列 + 数据长度 + 明文数据』。
   
ESP32端的安全实现
****************

1. 保证数据安全

   为了保证 Wi-Fi SSID 和密码的传输过程是安全的，需要使用对称加密算法（例如 AES、DES等）对报文进行加密。在使用对称加密算法之前，需要使用非对称加密算法（DH、RSA、ECC 等）协商出（或生成出）一个共享密钥。

2. 保证数据完整性

   保证数据完整性，需要加入校验算法（例如 SHA1、MD5、CRC 等）。

3. 身份安全（签名）

   某些算法如 RSA 可以保证身份安全。有些算法如 DH，本身不能保证身份安全，需要添加其他算法来签名。

4. 防止重放攻击 (Replay Attack)

   加入帧发送序列（Sequence），并且序列参与数据校验。

   在 ESP32 端的代码中，你可以决定和开发密钥协商等安全处理的流程参考上述流程图）。手机应用向 ESP32 发送协商数据，将传送给应用层处理。如果应用层不处理，可使用 BLUFI 提供的 DH 加密算法来磋商密钥。应用层需向 BLUFI 注册以下几个与安全相关的函数：

.. highlight:: none

::

   typedef void (*esp_blufi_negotiate_data_handler_t)(uint8_t *data, int len, uint8_t **output_data, int *output_len, bool *need_free);

   该函数用来接收协商期间的正常数据 (normal data)，处理完成后，需要将待发送的数据使用 output_data 和 output_len 传出。
   
   BLUFI 会在调用完 negotiate_data_handler 后，发送 negotiate_data_handler 传出的 output_data。
   
   这里的两个『*』，因为需要发出去的数据长度未知，所以需要函数自行分配 (malloc) 或者指向全局变量，通过 need_free 通知是否需要释放内存。
 
.. highlight:: none

::

   typedef int (* esp_blufi_encrypt_func_t)(uint8_t iv8, uint8_t *crypt_data, int cyprt_len);	
    
   加密和解密的数据长度必须一致。其中 iv8 为帧的 8 bit 序列 (sequence)，可作为 iv 的某 8 bit 来使用。
  
.. highlight:: none

::
   
   typedef int (* esp_blufi_decrypt_func_t)(uint8_t iv8, uint8_t *crypt_data, int crypt_len);

   加密和解密的数据长度必须一致。其中 iv8 为帧的 8 bit 序列 (sequence)，可作为 iv 的某 8 bit 来使用。
   
.. highlight:: none

::
   
   typedef uint16_t (*esp_blufi_checksum_func_t)(uint8_t iv8, uint8_t *data, int len);
   
   该函数用来计算 CheckSum，返回值为 CheckSum 的值。BLUFI 会使用该函数返回值与包末尾的 CheckSum 做比较。
      
GATT 相关说明
*************

UUID 相关：
==========

BLUFI Service UUID： 0xFFFF，16 bit

BLUFI（手机-> ESP32）特性：0xFF01，主要权限：可写

BLUFI（ESP32 ->手机）特性：0xFF02，主要权限：可读可通知

.. note::

	1. 目前 ACK 机制已经在该 Profile 协议中定义，但是还没有代码实现。
	
	2. 其他部分均已实现。
