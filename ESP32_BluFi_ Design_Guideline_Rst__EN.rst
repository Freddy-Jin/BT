BLUFI
*****

BLUFI
*****

Overview
========
BluFi for ESP32 is a network-configuration funcion via Bluetooth channel.

It is built on the GATT protocol, which defines the procedure of ESP32 working as the GATT Server to connect the GATT Client (e.g. an SoftAP created by a mobile phone) through Wi-Fi or configuring for the SoftAP Profile. Sharding, data encryption, checksum verification in the BluFi layer are the key parts that need your attention.

The algorithms of symmetric encryption, asymmetric encryption and checksum support custmization on your demand in practical use. Here we use the DH algorithm for key negotiation, 128-AES algorithm for data encryption, and CRC16 algorithm for checksum verification.

The BluFi Flow:
---------------
The BluFi networking flow includes the configuration of the SoftAP and Station.

Take the configuration of the Station as an example to illustrate the core parts of the procedure, including broadcast, connection, service discovery, negotiation of the shared key, data transmission, connection status backhaul.

The procedure is as follows:
------------------------------

1. Set the ESP32 into GATT Server mode and then it will send broadcasts with specific *adv data*. You can customize this broadcast as needed, which is not a part of the BluFi Profile.

2. Use the APP installed on the mobile phone to search for this particular broadcast. The mobile phone will connect to ESP32 as the GATT Client once the broadcast is confirmed. The APP used during this part is up to you.

3. After the GATT connection is successfully established, the mobile phone will send a data frame for key negotiation to ESP32 (see the section of "The Formats of Data Frames" for details).

4. After ESP32 receives the data frame of key negotiation, it will parse the content according to the user-defined negotiation method.

5. The mobile phone works with ESP32 for key negotiation using the encryption algorithms such as DH, RSA or ECC

6. After the negotiation process is completed, the mobile phone will send a control frame for security-mode setup to ESP32.

7. When receiving this control frame, ESP32 will be able to encrypt and decrypt the communication data using the shared key and the security configuration.

8. The mobile phone sends the data frame defined in the section of "The Formats of Data Frames"，with the Wi-Fi configuration information to ESP32, including SSID, password, etc.

9. The mobile phone sends a control frame of Wi-Fi connection request to ESP32. When receiving this control frame, ESP32 will regard the communication of essential information as done and get ready to connect to the Wi-Fi.

10. After connecting to the Wi-Fi, ESP32 will send a control frame of Wi-Fi connection status report to the mobile phone，to report the connection status. At this point the networking procedure is completed.

.. note::

    1. After ESP32 receives the control frame of security-mode configuration, it will execute the operations in accordance with the defined security mode.

    2. The data lengths before and after symmetric encryption/decryption must stay the same. It also supports in-place encryption and decryption.

The Flow Chat of BluFi:

.. figure:: https://github.com/Freddy-Jin/ESP32_BLUFI_-Design_Guidelines/blob/master/Docs/Figure1.png
    :align: center
    :figclass: align-center

The Frame Formats Defined in BluFi
***************************************

The frame formats for the communication between the mobile phone APP and ESP32 is defined as follows:

The frame format with no fragment (8 bit)：

+------------+---------------+-----------------+-------------+----------------+----------------+
| Type       | Frame Control | Sequence Number | Data Length |      Data      | CheckSum       |
+------------+---------------+-----------------+-------------+----------------+----------------+
|      1     |       1       |        1        |      1      | ${Data Length} |        2       |
+------------+---------------+-----------------+-------------+----------------+----------------+

If the **Frame Ctrl** bit is enabled, the **Total length** bit indicates the length of data frame's rest part. It can tell the remote how much memory needs to be alloced.


The frame format with fragments（8 bit）：

+------------+---------------+-----------------+-------------+-------------------------------------------+----------------+
| Type       | Frame Control | Sequence Number | Data Length |                    Data                   | CheckSum       |
+------------+---------------+-----------------+-------------+-------------------------------------------+----------------+
|      1     |       1       |        1        |      1      | Total Content Length |       Content      |        2       |
+            +               +                 +             +----------------------+--------------------+                +
|            |               |                 |             |           2          | ${Data Length} - 2 |                |
+------------+---------------+-----------------+-------------+----------------------+--------------------+----------------+

Normally, the control frame does not contain data bits, except for Ack frame.

The format of Ack Frame（8 bit）：

+------------+---------------+-----------------+-------------+-----------------------+----------------+
| Type       | Frame Control | Sequence Number | Data Length |          Data         | CheckSum       |
+------------+---------------+-----------------+-------------+-----------------------+----------------+
|      1     |       1       |        1        |      1      | Acked Sequence Number |        2       |
+            +               +                 +             +-----------------------+                +
|            |               |                 |             |           1           |                |
+------------+---------------+-----------------+-------------+-----------------------+----------------+

1. Type

   Type field, taking 1 Byte, is divided into Type and Subtype that Type uses the lower 2 bit and Subtype uses the upper 6 bit.

   * The control frame is not encrypted for the time being and supports to be verified;

   * The data frame supports to be encrypted and verified.
+---------+--------+--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Type    | 含义   | Subtype      | 含义                                                   | 解释                                                                                                                                                                                      | 备注                                                                                                                                                                                                                                                                  |
+---------+--------+--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x0b’00 | 控制帧 | 0x0b’000000  | Ack                                                    | 用来回复对方发的帧，Ack 帧的数据域为要回复的帧的 Sequence 值。                                                                                                                            | Data 域为1 Byte 的 Sequence 值，与要回复的帧的Sequence 相同。                                                                                                                                                                                                         |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x1b’000001  | Set ESP32 to Phone Security mode                       | 通知 ESP32，ESP32 发送数据时使用的安全模式，过程中可多次设置。每次设置后影响后续安全模式。不设置的情况下，ESP32 默认控制帧和数据帧均为无校验、无加密。手机到 ESP32 方向依赖于帧控制域。   | Data 域 1 字节。高 4 bit 为控制帧的安全模式，低 4bit 为数据帧的安全模式。b’0000 为无校验、无加密；b’0001 为有校验、无加密；b’0010 为无校验、有加密；b’0011 为有校验有加密。                                                                                           |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x2b’000010  | Set Wi-Fi Opmode                                       | 设置 ESP32 的 Wi-Fi 模式，帧包含 opmode。                                                                                                                                                 | data[0] 表示 opmode：0x00: NULL；0x01: STA;0x02: SoftAP;0x03: SoftAP&STA如果设置有包含 AP，请尽量优先设置 AP 模式的SSID/PASSWORD/Max Conn Number等。                                                                                                                  |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x3b’000011  | Connect to AP                                          | 通知 ESP32，必要的信息已经发送完毕，可以连接 AP。                                                                                                                                         | 无数据域。                                                                                                                                                                                                                                                            |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x4b’000100  | Disconnect From AP                                     | 通知 ESP32 断开与 AP 的连接                                                                                                                                                               | 无数据域。                                                                                                                                                                                                                                                            |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x5b’000101  | Get Wifi Status                                        | 获取 ESP32 的 Wi-Fi 模式和状态等信息。                                                                                                                                                    | 无数据域。ESP32 收到此控制帧后，后续会通过 Wi-Fi Connection State Report 数据帧来回复手机端当前所处的 opmode、连接状态、SSID 等信息。这些信息由应用决定提供给手机端多少信息。                                                                                         |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x6b’000110  | Deauthenticate STA Device from SOFTAP( in SoftAP mode) | 踢掉某个 STA 设备。（SOFTAP mode）                                                                                                                                                        | data[0~5] 为 STA 的 MAC 地址，如多个 STA，则 [6-11] 为第二个，依次类推。                                                                                                                                                                                              |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x7b'000111  | Get Version                                            |                                                                                                                                                                                           |                                                                                                                                                                                                                                                                       |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x8b’001000  | ESP32 Close BLE GATT Connection                        | 通知 ESP32 断开蓝牙连接                                                                                                                                                                   | ESP32 收到该指令后主动断开蓝牙连接。                                                                                                                                                                                                                                  |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x9b’001001  | ESP32 Get Wi-fi List                                   | 通知 ESP32 扫描周围的 Wi-Fi 热点                                                                                                                                                          | 无数据域ESP32收到此控制帧后，后续会通过Wifi List Report数据帧来回复手机端当前ESP32 周围的Wifi 热点。                                                                                                                                                                  |
+---------+--------+--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x1b’01 | 数据帧 | 0x0b’000000  | Negotiate Data                                         | 用来发送协商数据，将会传给应用层注册的回调函数                                                                                                                                            | 数据长度与 Length 域有关。                                                                                                                                                                                                                                            |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x1b’000001  | BSSID for STA mode                                     | STA将要连接的AP的BSSID（为隐藏SSID用）。                                                                                                                                                  | 数据长度与 Length 域有关。当传输方向为 ESP32 到手机时，表示向手机端提供信息。                                                                                                                                                                                         |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x2b’000010  | SSID for STA mode                                      | STA 将要连接的 AP 的 SSID                                                                                                                                                                 | 数据长度与 Length 域有关。当传输方向为 ESP32 到手机时，表示向手机端提供信息。                                                                                                                                                                                         |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x3b’000011  | Password for STA mode                                  | STA 将要连接的 AP 的密码                                                                                                                                                                  | 数据长度与 Length 域有关。当传输方向为 ESP32 到手机时，表示向手机端提供信息。                                                                                                                                                                                         |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x4b’000100  | SSID for SoftAP mode                                   | SoftAP 模式使用的 SSID                                                                                                                                                                    | 数据长度与 Length 域有关。当传输方向为ESP32 到手机时，表示向手机端提供信息。                                                                                                                                                                                          |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x5b’000101  | Password for SoftAPmode                                | SoftAP 模式使用的密码                                                                                                                                                                     | 数据长度与 Length 域有关。当传输方向为 ESP32 到手机时，表示向手机端提供信息。                                                                                                                                                                                         |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x6b’000110  | Max Connection Number for SoftAP mode                  | AP 模式的最大连接数                                                                                                                                                                       | data[0] 表示连接数的值。范围 1~4。当传输方向为 ESP32 到手机时，表示向手机端提供信息。                                                                                                                                                                                 |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x7b’000111  | Authentication mode for SoftAP mode                    | AP 模式的认证模式                                                                                                                                                                         | data[0]：0x00: OPEN0x01: WEP0x02: WPA_PSK0x03: WPA2_PSK0x04:WPA_WPA2_PSK。当传输方向为 ESP32 到手机时，表示向手机端提供信息。                                                                                                                                         |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x8b’001000  | Channel For SoftAP mode                                | SoftAP 模式的 Channel                                                                                                                                                                     | data[0] 为 Channel 值。范围 1~14。当传输方向为 ESP32 到手机时，表示向手机端提供信息。                                                                                                                                                                                 |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x9b’001001  | Username                                               | 使用企业级加密时，Client 端的 username                                                                                                                                                    | 数据长度与 Length 域有关                                                                                                                                                                                                                                              |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0xab’001010  | CA Certification                                       | 企业级加密时，CA 证书                                                                                                                                                                     | 数据长度与 Length 域有关，长度不够，可用分片。                                                                                                                                                                                                                        |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0xbb’001011  | Client Certification                                   | 企业级加密时，Client端的证书（可包含或不包含Private Key，由证书内容决定）                                                                                                                 | 数据长度与 Length 域有关，长度不够，可用分片。                                                                                                                                                                                                                        |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0xcb’001100  | Server Certification                                   | 企业级加密时，Server 端的证书（可包含或不包含 Private Key，由证书内容决定）                                                                                                               | 数据长度与 Length 域有关，长度不够，可用分片。                                                                                                                                                                                                                        |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0xdb’001101  | ClientPrivate Key                                      | 企业级加密时，Client 端的私钥。                                                                                                                                                           | 数据长度与 Length 域有关，长度不够，可用分片。                                                                                                                                                                                                                        |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0xeb’001110  | ServerPrivate Key                                      | 企业级加密时，Server 端的私钥。                                                                                                                                                           | 数据长度与 Length 域有关，长度不够，可用分片。                                                                                                                                                                                                                        |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0xfb’001111  | Wi-Fi Connection State Report                          | 通知手机 ESP32 的 Wi-Fi 状态，包括 STA状态和 SoftAP 状态。用于手机配置 STA 连接时的通知，或有 STA 连接上 SoftAP 时的通知。但收到手机询问 Wi-Fi 状态，除了回复此帧外，还可回复其他数据帧。 | data[0]:表示 opmode，0x00: NULL；0x01: STA;0x02: SoftAP;0x03: SoftAP&STAdata[1]：表示 STA 的连接状态，0x0 表示处于连接状态， 其他表示处于非连接状态；data[2]：表示 SoftAP 的连接状态，即表示有多少 STA 已经连接。data[3] 及以后，为按照本协议格式 SSID\BSSID 等信息。 |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x10b’010000 | Version                                                |                                                                                                                                                                                           | data[0]= great versiondata[1]=sub version                                                                                                                                                                                                                             |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x11B’010001 | Wifi List                                              | 通知手机，包含 ESP32 周围的 Wi-Fi 热点列表。                                                                                                                                              | 数据帧数据格式为 ( Length + RSSI + SSID ), 数据较长时分片发送                                                                                                                                                                                                         |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x12B’010010 | Report Error                                           | 通知手机, BLUFI 出现异常错误。                                                                                                                                                            | 0x00: sequence error0x01: checksum error0x02: decrypt error0x03: encrypt error0x04: init security error0x05: dh malloc error0x06: dh param error0x07: read param  error0x08: make public error                                                                        |
+         +        +--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         |        | 0x13B’010011 | Custom Data                                            | 用户发送或者接收自定义数据。                                                                                                                                                              | 数据较长时分片发送。                                                                                                                                                                                                                                                  |
+---------+--------+--------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

2. Frame Control

   帧控制域，占 1 Byte，每个 bit 表示不同含义。
   
+----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| bit            | 含义                                                                                                                                                                                                                  |
+----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x01           | 表示帧是否加密。1 表示加密，0 表示未加密。加密部分帧括完整的 Data 域加密之前的明文（不帧含末尾的校验）。控制帧暂不加密，故控制帧此位为 0。                                                                            |
+----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x02           | 表示帧 Data 域结尾是否帧含校验（例如 SHA1、MD5、CRC等）需要校验的数据域包括『序列 + 数据长度 + 明文数据』。控制帧和数据帧都可以包含校验位或不包含。                                                                   |
+----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x04           | 表示数据方向。0 表示手机发向 ESP32；1 表示 ESP32 发向手机。                                                                                                                                                           |
+----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x08           | 表示是否要求对方回复 Ack。0 表示不要求；1 表示要求回复 Ack。                                                                                                                                                          |
+----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x10           | 表示是否有后续的数据分片。0 表示此帧没有后续数据分片；1 表示还有后续数据分片。用来传输较长的数据。如果是 Frag 帧，则告知当前『内容部分+后续内容部分』的总长度，位于 Data 域的前 2 Byte (即最大支持 64K 的内容数据）。 |
+----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0x10~0x80 保留 |                                                                                                                                                                                                                       |
+----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

3. Sequence Control

   序列控制域。帧发送时，无论帧的类型是什么，序列 (Sequence) 都会自动加 1，用来防止重放攻击 (Replay Attack)。每次重现连接后，序列清零。
   
4. Length

   Data 域的长度，不包含 CheckSum。
   
5. Data

   不同的 Type 或 Subtype，Data 域的含义均不同。请参考上方表格。

6. CheckSum

   此域为 2 Byte 的校验，用来校验『序列 + 数据长度 + 明文数据』。
   
ESP32端的安全实现
****************

1. 保证数据安全

   为了保证 Wi-Fi SSID 和密码的传输过程是安全的，需要使用对称加密算法（例如 AES、DES等）对报文进行加密。在使用对称加密算法之前，需要使用非对称加密算法（DH、RSA、ECC 等）协商出（或生成出）一个共享密钥。

2. 保证数据完整性

   保证数据完整性，需要加入校验算法（例如 SHA1、MD5、CRC 等）。

3. 身份安全（签名）

   某些算法如 RSA 可以保证身份安全。有些算法如 DH，本身不能保证身份安全，需要添加其他算法来签名。

4. 防止重放攻击 (Replay Attack)

   加入帧发送序列（Sequence），并且序列参与数据校验。

   在 ESP32 端的代码中，你可以决定和开发密钥协商等安全处理的流程参考上述流程图）。手机应用向 ESP32 发送协商数据，将传送给应用层处理。如果应用层不处理，可使用 BLUFI 提供的 DH 加密算法来磋商密钥。应用层需向 BLUFI 注册以下几个与安全相关的函数：

.. highlight:: none

::

   typedef void (*esp_blufi_negotiate_data_handler_t)(uint8_t *data, int len, uint8_t **output_data, int *output_len, bool *need_free);

   该函数用来接收协商期间的正常数据 (normal data)，处理完成后，需要将待发送的数据使用 output_data 和 output_len 传出。
   
   BLUFI 会在调用完 negotiate_data_handler 后，发送 negotiate_data_handler 传出的 output_data。
   
   这里的两个『*』，因为需要发出去的数据长度未知，所以需要函数自行分配 (malloc) 或者指向全局变量，通过 need_free 通知是否需要释放内存。
 
.. highlight:: none

::

   typedef int (* esp_blufi_encrypt_func_t)(uint8_t iv8, uint8_t *crypt_data, int cyprt_len);	
    
   加密和解密的数据长度必须一致。其中 iv8 为帧的 8 bit 序列 (sequence)，可作为 iv 的某 8 bit 来使用。
  
.. highlight:: none

::
   
   typedef int (* esp_blufi_decrypt_func_t)(uint8_t iv8, uint8_t *crypt_data, int crypt_len);

   加密和解密的数据长度必须一致。其中 iv8 为帧的 8 bit 序列 (sequence)，可作为 iv 的某 8 bit 来使用。
   
.. highlight:: none

::
   
   typedef uint16_t (*esp_blufi_checksum_func_t)(uint8_t iv8, uint8_t *data, int len);
   
   该函数用来计算 CheckSum，返回值为 CheckSum 的值。BLUFI 会使用该函数返回值与包末尾的 CheckSum 做比较。
      
GATT 相关说明
*************

UUID 相关：
==========

BLUFI Service UUID： 0xFFFF，16 bit

BLUFI（手机-> ESP32）特性：0xFF01，主要权限：可写

BLUFI（ESP32 ->手机）特性：0xFF02，主要权限：可读可通知

.. note::

	1. 目前 ACK 机制已经在该 Profile 协议中定义，但是还没有代码实现。
	
	2. 其他部分均已实现。
